{% extends "elections/election_base.html" %}
{% load staticfiles %}
{% load candideitorg_templetags %}
{% load i18n %}
{% load thumbnail %}
{% load votainteligente_extras %}

{% block url_face_to_face %}{% url 'face_to_face_one_candidate_detail_view' slug=election.slug slug_candidate_one=candidate.slug %}{% endblock url_face_to_face %}

{% block title %} - {{election}} - {{candidate.name}}{% endblock title%}

{% block tab_profile %}class="active"{% endblock %}

{% block mainelection %}
	<div class="container-profile">
		<div>
			<h3>{{ candidate.name }}</h3>
		</div>

		<div class="profile-candidate">
			<div class="row">
				<div class="col-md-3 {% if not candidate.has_answered %}not_answered{% endif %}">
					<div id="candidate-img-profile">
						{% if candidate.photo %}
						{% thumbnail candidate.photo "300x300" crop="center" as im %}
						<img src="{{im.url}}" alt="{{candidate.name}}" border="0" class="img-responsive">
						{% endthumbnail %}
						{% else %}
						<img src="{% static 'img/candidate-default.jpg' %}" alt="{{candidate.name}}" border="0" class="img-responsive">
						{% endif %}
						
						<img id="apoya" src="{% static 'img/hover-caraacara.png' %}" alt="{% trans "Apoya a tu candidato" %}" title="{% trans "Apoya a tu candidato" %}">
					</div>
					
					{% if candidate.relation.portrait_photo %}
					<a class="btn btn-default button_pic" data-toggle="modal" href="#myCandidate" class="hidden-xs" style="margin-bottom:5px"><i class="icon-camera"></i> Da la cara por tu candidato</a>
					
					<div class="modal fade" id="myCandidate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title"><i class="icon-camera"></i> Da la cara por tu candidato</h4>
								</div>
								<div class="modal-body container_pic">
									<div id="text-support" class="alert alert-warning alert-dismissable">
										<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
										{% trans "Recuerda activar tu cámara" %} <i class="icon-arrow-up"></i>
									</div>
									<div id="videocontainer">
										<video id="video"></video>
										
										<img src="{{candidate.relation.portrait_photo}}" id="soulmate-pic" alt="{{candidate.name}}" title="{{candidate.name}}">
										
									</div>
									<canvas id="canvas"></canvas>
									<div id="cover"></div>
								</div>
								<div id="controls" class="modal-footer">
									<span id="socialsharehalfface" class="text-left" style="display:none">
										<input type="text" id="shareurl" value="" style="width:39%" onclick="this.select();">
										 <a href="#" id="shareurltwitter" onClick="#"><i class="icon-twitter-sign"></i> compartir</a>
										 <a href="#" id="shareurlfacebook" onClick="#"><i class="icon-facebook-sign"></i> publicar</a>
									</span>
									<button type="button" class="btn btn-default" id="resetbutton" style="display:none"><i id="icon-repeat" class="icon-repeat"></i> {% trans "Tomar otra foto" %}</button>
									<button type="button" class="btn btn-primary" id="takepicbutton"><i class="icon-camera"></i> {% trans "Tomar foto" %}</button>
									<button type="button" class="btn btn-success" id="uploadbutton" style="display:none">{% trans "OK" %}</button>
								</div>
							</div><!-- /.modal-content -->
						</div><!-- /.modal-dialog -->
					</div><!-- /.modal -->
					{% endif %}

				</div>
				<div class="col-md-5">
					<table class="table">
						{% for personal_data in election.can_election.personaldata_set.all %}
						<tr>
							<td>
								<span>{{personal_data.label}}:</span>
									{% relation_personal_data_candidate candidate personal_data %}
							</td>
						</tr>
						{% endfor %}
					</table>
				</div>
				
				<div class="col-md-4 social-side">
					<ul class="list-unstyled">
						{% for link in candidate.link_set.all %}
							<li><a href="{{link.url}}" class="social-link-candidate" target="_blank"><i class="{{ link.icon_class }}"></i> {{link.name}}</a></li>
						{% endfor %}
					</ul>
					
					{% if 'ask'|val_navbars and election.uses_preguntales  %}
					<button type="button" class="btn btn-success btn-lg btn-block" onClick="location.href='{% url 'ask_detail_view' slug=election.slug %}'"><i class="icon-edit"></i> {% trans "Hazle una pregunta" %}</button>
					{% endif %}
					{% if 'facetoface'|val_navbars and election.uses_face_to_face  %}
					<button type="button" class="btn btn-danger btn-lg btn-block" onClick="location.href='{% url 'face_to_face_one_candidate_detail_view' slug=election.slug slug_candidate_one=candidate.slug %}'"><i class="icon-bolt"></i> {% trans "Compáralo con otro candidato" %}</button>
					{% endif %}
					
				</div>
			</div>
			
			<div class="row">
				<div class="antecedentes col-md-12">
					<div class="info">
					{% for background_category in election.can_election.backgroundcategory_set.all %}
			 			{% for background in background_category.background_set.all %}
			 				{% for background_candidate in background.backgroundcandidate_set.all %}
				 				{{background_candidate.value}}
			 				{% endfor %}
			 			{% endfor %}
			 		{% endfor %}

			 		{% if candidate.relation.description %}
					{{ candidate.relation.description|linebreaks }}
					{% endif %}
			 		</div>
			 	</div>
			</div>
		</div>

	</div>

	<div class="questionary">
		<h3>{% trans "Cuestionario" %} {% if not candidate.has_answered %}{% no_ha_respondido_twitter_button %}{% endif %}</h3>

		{% for category in election.can_election.category_set.all %}
		<div class="panel panel-default">
			<div class="panel-heading">{{category.name}}</div>
			<div class="panel-body">
				{% for question in category.question_set.all %}
				<div class="question-answer" {% if forloop.counter >= 2 %}style="margin-top:5px;" {% endif %}>
					<p class="question">
						{{question.question}}
					</p>
					<p class="answer">
						<i class="icon-quote-left"></i> {% answer_for_candidate_and_question candidate question %} <i class="icon-quote-right"></i>
						<!-- source -->
						{% get_information_source candidate question %} 
						<!-- eosource -->
					</p>
				</div>
				{% endfor %}
			</div>
		</div>
		{% endfor %}

	</div>

	{% if 'enabled'|disqus and 'shortname'|disqus %}
	<div class="disqus">
		<div id="disqus_thread"></div>
	    <script type="text/javascript">
	        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	        var disqus_shortname = '{{ 'shortname'|disqus }}'; // required: replace example with your forum shortname
	        var disqus_developer = {{ 'dev_mode'|disqus }};
	        /* * * DON'T EDIT BELOW THIS LINE * * */
	        (function() {
	            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	        })();
	    </script>
	    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>

	
	{% endif %}
	<!--<script src="{% static 'js/interactioncam.js' %}"></script>-->
	
{% endblock mainelection %}

{% block extrajs %}
	$(document).ready(function() {
		$('div.antecedentes div.info').expander({
			expandText: '<i class="icon-chevron-down"></i>',
			userCollapseText: '<i class="icon-chevron-up"></i>',
			slicePoint: 180,
		});

		$('.pop-fuente').popover();
	});

(function() {

  var API_KEY = '{{ 'client_id'|website_imgur }}';

  var streaming = false,
      video        = document.querySelector('#video'),
      cover        = document.querySelector('#cover'),
      canvas       = document.querySelector('#canvas'),
      resetbutton  = document.querySelector('#resetbutton'),
      uploadbutton = document.querySelector('#uploadbutton'),
      urlfield     = document.querySelector('#uploaded input'),
      urllink      = document.querySelector('#uploaded a'),
      button_pic    = document.querySelector('a.button_pic'),
      takepicbutton = document.querySelector('#takepicbutton'),
      closebutton = document.querySelector('.close'),
      width = 600,
      height = 0,
      finalheight = 0,
      state = 'intro';
      setstate(state);
  function init() {
    navigator.getMedia = ( navigator.getUserMedia ||
                           navigator.webkitGetUserMedia ||
                           navigator.mozGetUserMedia ||
                           navigator.msGetUserMedia);

    navigator.getMedia(
      {
        video: true,
        audio: false
      },
      function(stream) {
        if (navigator.mozGetUserMedia) {
          video.mozSrcObject = stream;
        } else {
          var vendorURL = window.URL || window.webkitURL;
          video.src = vendorURL ? vendorURL.createObjectURL(stream) : stream;
        }
        video.play();
      },
      function(err) {
        console.log("An error occured! " + err);
      }
    );
  }

  function takepicture() {
    canvas.width = width;
    canvas.height = finalheight;

    context = canvas.getContext('2d');
    //context.scale(-1, 1);

    context.drawImage(video, 0, 0, width, finalheight);
    
    var img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = document.getElementById('soulmate-pic').getAttribute("src");

    context = canvas.getContext('2d');
    context.drawImage(img, 0, 0, 289, 450); //output picture

    document.getElementById('videocontainer').setAttribute('style','display:none');
    document.getElementById('canvas').setAttribute('style','');
    document.getElementById('uploadbutton').setAttribute('style','');
    document.getElementById('takepicbutton').setAttribute('style','display:none');
    document.getElementById('icon-repeat').classList.add('icon-spin');
    document.getElementById('resetbutton').setAttribute('style','');
  }


  function initiateupload() {
    if (state === 'reviewing') {
      setstate('uploading');
      upload();
    }
  }

  function upload() {

	document.getElementById('resetbutton').setAttribute('style','display:none');
  	document.getElementById('uploadbutton').innerHTML = '<i class="icon-gear icon-spin"></i> Cargando';
    
    var head = /^data:image\/(png|jpg);base64,/,
        fd = new FormData(),toSend,
        xhr = new XMLHttpRequest(),
        links = '',
        data = '',
        originalImage= '';

    data = ('mozGetAsFile' in canvas) ? canvas.mozGetAsFile('webcam.png') : canvas.toDataURL('image/png').replace(head, '');
    
    fd.append('image', data);
    fd.append('key', API_KEY);
    xhr.open('POST', 'http://api.imgur.com/2/upload.json');
    xhr.addEventListener('error', function(ev) {
      console.log('Upload Error :');
    }, false);
    xhr.addEventListener('load', function(ev) {
      try {
        var links = JSON.parse(xhr.responseText).upload.links;

        var twtwindow = "https://twitter.com/share?url=http://{% url_domain %}{% url 'candidate_detail_view' election_slug=election.slug slug=candidate.slug %}&text={{candidate.name}}+%3C3+"+links.original+"&hashtags=medianaranja,votainteligente";
        var fcbkwindow = "https://www.facebook.com/sharer/sharer.php?u="+links.original;

        document.getElementById('socialsharehalfface').setAttribute('style','');
        document.getElementById('shareurl').setAttribute('value', links.original);
        document.getElementById('shareurltwitter').setAttribute('onClick','window.open(\''+twtwindow+'\', \'twitter-share-dialog\', \'width=626,height=436\')');
        document.getElementById('shareurlfacebook').setAttribute('onClick','window.open(\''+fcbkwindow+'\', \'twitter-share-dialog\', \'width=626,height=436\')');
        document.getElementById('uploadbutton').innerHTML = 'OK';
        document.getElementById('uploadbutton').setAttribute('style','display:none');
        document.getElementById('resetbutton').setAttribute('style','');

      } catch(e) {
        console.log('Upload Error :' + e);
      }
    }, false);
    xhr.send(fd);
  }

  function setstate(newstate) {
    state = newstate;
    document.body.className = newstate;  
  }

	 
  /* Event Handlers */

	button_pic.addEventListener('mouseover', function() {
		document.getElementById('apoya').setAttribute('style','display:block');
	},false);

	button_pic.addEventListener('mouseout', function() {
		document.getElementById('apoya').setAttribute('style','display:none');
	},false);

	button_pic.addEventListener('click', function(ev) {
		if (state === 'intro') {
			setstate('playing');
			init();
		} else {
			setstate('reviewing');
			takepicture();
		}
		ev.preventDefault();
	},false);

	takepicbutton.addEventListener('click', function(ev) {
		ev.preventDefault();
		takepicture();
	},false);

	resetbutton.addEventListener('click', function(ev){
		if (state === 'reviewing') {
			setstate('playing');
		}

		document.getElementById('videocontainer').setAttribute('style','');
		document.getElementById('canvas').setAttribute('style','display:none');
		document.getElementById('uploadbutton').setAttribute('style','display:none');
		document.getElementById('takepicbutton').setAttribute('style','');
		document.getElementById('icon-repeat').classList.remove('icon-spin');
		document.getElementById('resetbutton').setAttribute('style','display:none');
		document.getElementById('socialsharehalfface').setAttribute('style','display:none');
		ev.preventDefault();
	}, false);

	uploadbutton.addEventListener('click', function(ev){
		upload();
		ev.preventDefault();
	}, false);

	video.addEventListener('canplay', function(ev){
		if (!streaming) {
			finalheight = video.videoHeight / (video.videoWidth/width);

			video.setAttribute('width', width);
			video.setAttribute('height', finalheight);

			canvas.setAttribute('width', width);
			canvas.setAttribute('height', finalheight);

			streaming = true;
		}

	}, false);

})();

{% endblock extrajs %}